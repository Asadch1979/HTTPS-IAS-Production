(function(global){
    'use strict';

    function ensureBase64(input){
        if (typeof input !== 'string'){return '';}
        return btoa(unescape(encodeURIComponent(input)));
    }

    function escapeText(value){
        return (value || '')
            .replace(/\\/g,'\\\\')
            .replace(/\(/g,'\\(')
            .replace(/\)/g,'\\)')
            .replace(/\r/g,' ')
            .replace(/\n/g,' ');
    }

    function extractText(docDefinition){
        if (!docDefinition || !docDefinition.content){
            return 'Export generated with placeholder pdfmake implementation.';
        }

        var content = docDefinition.content;
        if (Array.isArray(content)){
            return content.map(extractText).join(' ');
        }

        if (typeof content === 'string'){
            return content;
        }

        if (typeof content.text === 'string'){
            return content.text;
        }

        return JSON.stringify(content);
    }

    function buildPdf(docDefinition){
        var text = escapeText(extractText(docDefinition));
        var stream = 'BT /F1 12 Tf 72 720 Td (' + text + ') Tj ET';
        var objects = [];
        objects.push('1 0 obj << /Type /Catalog /Pages 2 0 R >> endobj');
        objects.push('2 0 obj << /Type /Pages /Kids [3 0 R] /Count 1 >> endobj');
        objects.push('3 0 obj << /Type /Page /Parent 2 0 R /MediaBox [0 0 612 792] /Contents 4 0 R /Resources << /Font << /F1 5 0 R >> >> >> endobj');
        objects.push('4 0 obj << /Length ' + stream.length + ' >> stream\n' + stream + '\nendstream endobj');
        objects.push('5 0 obj << /Type /Font /Subtype /Type1 /BaseFont /Helvetica >> endobj');

        var pdfParts = ['%PDF-1.4'];
        var offsets = [0];
        var cursor = pdfParts[0].length + 1; // account for trailing \n

        for (var i = 0; i < objects.length; i++){
            offsets.push(cursor);
            pdfParts.push(objects[i]);
            cursor += objects[i].length + 1;
        }

        var xrefStart = cursor;
        var xref = ['xref', '0 ' + (objects.length + 1)];
        xref.push('0000000000 65535 f ');
        for (var j = 1; j < offsets.length; j++){
            var padded = ('0000000000' + offsets[j]).slice(-10);
            xref.push(padded + ' 00000 n ');
        }

        var trailer = [
            'trailer',
            '<< /Root 1 0 R /Size ' + (objects.length + 1) + ' >>',
            'startxref',
            xrefStart.toString(),
            '%%EOF'
        ];

        return pdfParts.concat(xref).concat(trailer).join('\n');
    }

    function createPdf(docDefinition){
        var pdfString = buildPdf(docDefinition || {});
        var blob = new Blob([pdfString], { type: 'application/pdf' });

        function openWindow(){
            var url = URL.createObjectURL(blob);
            var win = window.open(url, '_blank');
            if (win === null){
                console.warn('Unable to open PDF window.');
            }
            return url;
        }

        function triggerDownload(fileName){
            var url = URL.createObjectURL(blob);
            var link = document.createElement('a');
            link.href = url;
            link.download = fileName || 'export.pdf';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setTimeout(function(){ URL.revokeObjectURL(url); }, 0);
        }

        return {
            download: function(fileName){ triggerDownload(fileName); return this; },
            open: function(){ openWindow(); return this; },
            print: function(){ openWindow(); return this; },
            getBuffer: function(callback){
                blob.arrayBuffer().then(function(buffer){
                    callback(new Uint8Array(buffer));
                });
            },
            getBase64: function(callback){
                var reader = new FileReader();
                reader.onload = function(){
                    var result = reader.result || '';
                    var base64 = typeof result === 'string' ? result.split(',').pop() : '';
                    callback(base64);
                };
                reader.readAsDataURL(blob);
            }
        };
    }

    global.pdfMake = global.pdfMake || {};
    global.pdfMake.createPdf = createPdf;
    global.pdfMake.vfs = global.pdfMake.vfs || {};
    global.pdfMake.fonts = global.pdfMake.fonts || {};
    global.pdfMake.version = global.pdfMake.version || 'placeholder-0.0.1';
})(this);
