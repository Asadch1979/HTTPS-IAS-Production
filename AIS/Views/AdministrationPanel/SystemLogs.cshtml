@{
    ViewData["Title"] = "System Logs";
    Layout = "_Layout";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <h2>System Logs</h2>
            <p class="text-muted">Use filters to review application log activity. Results are read-only.</p>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="logStartTime">Start time</label>
                    <input id="logStartTime" type="text" class="form-control system-log-datetime" placeholder="YYYY-MM-DD hh:mm AM/PM" />
                </div>
                <div class="col-md-3 mb-3">
                    <label for="logEndTime">End time</label>
                    <input id="logEndTime" type="text" class="form-control system-log-datetime" placeholder="YYYY-MM-DD hh:mm AM/PM" />
                </div>
                <div class="col-md-2 mb-3">
                    <label for="logLevel">Level</label>
                    <select id="logLevel" class="form-control">
                        <option value="">All</option>
                        <option value="INFO">Info</option>
                        <option value="WARNING">Warning</option>
                        <option value="ERROR">Error</option>
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <label for="logModule">Module</label>
                    <input id="logModule" type="text" class="form-control" placeholder="Module" />
                </div>
                <div class="col-md-2 mb-3">
                    <label for="logUserPpno">User PPNO</label>
                    <input id="logUserPpno" type="text" class="form-control" placeholder="User" />
                </div>
                <div class="col-md-2 mb-3">
                    <label for="logEngId">Engagement ID</label>
                    <input id="logEngId" type="number" class="form-control" placeholder="Engagement" />
                </div>
                <div class="col-md-2 mb-3 d-flex align-items-end">
                    <button id="loadSystemLogs" class="btn btn-primary w-100" type="button">Load Logs</button>
                </div>
            </div>
            <div id="systemLogsMessage" class="text-danger"></div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body table-responsive">
            <table class="table table-bordered table-striped" id="systemLogsTable">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Level</th>
                        <th>Module</th>
                        <th>Controller</th>
                        <th>Action</th>
                        <th>Message</th>
                        <th>Tech Details</th>
                        <th>Page</th>
                        <th>Engagement</th>
                        <th>User</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h5 class="mb-3">Delete old logs</h5>
            <div class="row align-items-end">
                <div class="col-md-4 mb-3">
                    <label for="deleteLogCutoffTime">Cutoff datetime</label>
                    <input id="deleteLogCutoffTime" type="text" class="form-control system-log-datetime" placeholder="YYYY-MM-DD hh:mm AM/PM" />
                </div>
                <div class="col-md-3 mb-3">
                    <label for="deleteLogDays">Older than (days)</label>
                    <input id="deleteLogDays" type="number" class="form-control" min="1" placeholder="e.g. 30" />
                </div>
                <div class="col-md-3 mb-3">
                    <button id="deleteOldLogs" class="btn btn-danger w-100" type="button">Delete</button>
                </div>
                <div class="col-md-2 mb-3 text-muted small">
                    This cannot be undone.
                </div>
            </div>
            <div id="systemLogsDeleteMessage"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script type="text/javascript">
    $(document).ready(function () {
        initSystemLogDatePickers();
        $('#loadSystemLogs').on('click', function () {
            fetchSystemLogs();
        });

        $('#deleteOldLogs').on('click', function () {
            deleteOldSystemLogs();
        });

        fetchSystemLogs();
    });

    function initSystemLogDatePickers() {
        if (typeof flatpickr === 'undefined') {
            return;
        }

        $('.system-log-datetime').flatpickr({
            enableTime: true,
            dateFormat: 'Y-m-d h:i K',
            time_24hr: false,
            allowInput: true
        });
    }

    function fetchSystemLogs() {
        $('#systemLogsMessage').text('');

        $.ajax({
            // IMPORTANT: pick the correct one
            url: g_asiBaseURL + "/ApiCalls/GetSystemLogs",
            // url: g_asiBaseURL + "/AdministrationPanel/GetSystemLogs",

            type: "POST",
            dataType: "json",
            data: {
                // Controller expects: start, end (NOT startTime/endTime)
                start: $('#logStartTime').val(),
                end: $('#logEndTime').val(),
                logLevel: $('#logLevel').val(),
                module: $('#logModule').val(),
                userPpno: $('#logUserPpno').val(),
                engId: $('#logEngId').val()
            },
            cache: false,
            success: function (response) {
                if (!response || response.status !== true) {
                    $('#systemLogsMessage').text('Unable to load system logs.');
                    renderSystemLogs([]);
                    return;
                }

                // response.data is already the array
                renderSystemLogs(response.data || []);
            },
            error: function (xhr) {
                $('#systemLogsMessage').text('Unable to load system logs.');
                renderSystemLogs([]);
            }
        });
    }


    function deleteOldSystemLogs() {
        $('#systemLogsDeleteMessage').removeClass('text-success text-danger').text('');

        var cutoffValue = $('#deleteLogCutoffTime').val();
        var daysValue = $('#deleteLogDays').val();
        var cutoffTime = '';

        if (daysValue) {
            var parsedDays = Number(daysValue);
            if (Number.isNaN(parsedDays) || parsedDays <= 0) {
                $('#systemLogsDeleteMessage').addClass('text-danger').text('Please enter a valid number of days.');
                return;
            }
            var cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - parsedDays);
            cutoffTime = formatDateTime(cutoffDate);
        } else if (cutoffValue) {
            cutoffTime = cutoffValue;
        }

        if (!cutoffTime) {
            $('#systemLogsDeleteMessage').addClass('text-danger').text('Please select a cutoff datetime or enter days.');
            return;
        }

        if (!confirm('Delete logs older than the selected cutoff? This cannot be undone.')) {
            return;
        }

        $.ajax({
            url: g_asiBaseURL + "/AdministrationPanel/DeleteSystemLogs",
            type: "POST",
            data: {
                cutoffTime: cutoffTime
            },
            cache: false,
            success: function (resp) {
                $('#systemLogsDeleteMessage').addClass('text-success').text('Deleted ' + (resp.deletedCount || 0) + ' log(s).');
                fetchSystemLogs();
            },
            error: function () {
                $('#systemLogsDeleteMessage').addClass('text-danger').text('Unable to delete old logs.');
            }
        });
    }

    function formatDateTime(date) {
        var year = date.getFullYear();
        var month = String(date.getMonth() + 1).padStart(2, '0');
        var day = String(date.getDate()).padStart(2, '0');
        var hours = date.getHours();
        var minutes = String(date.getMinutes()).padStart(2, '0');
        var ampm = hours >= 12 ? 'PM' : 'AM';
        var displayHours = hours % 12;
        displayHours = displayHours ? displayHours : 12;
        var hourString = String(displayHours).padStart(2, '0');
        return year + '-' + month + '-' + day + ' ' + hourString + ':' + minutes + ' ' + ampm;
    }

        function renderSystemLogs(logs) {
        var tbody = $('#systemLogsTable tbody');
        tbody.empty();

        if (!logs || logs.length === 0) {
            tbody.append('<tr><td colspan="10" class="text-center">No logs found.</td></tr>');
            return;
        }

        $.each(logs, function (index, log) {
            var row = $('<tr></tr>');
            row.append($('<td></td>').text(formatLogTime(log.LOG_TIME)));
            row.append($('<td></td>').text(log.LOG_LEVEL || ''));
            row.append($('<td></td>').text(log.MODULE || ''));
            row.append($('<td></td>').text(log.CONTROLLER || ''));
            row.append($('<td></td>').text(log.ACTION || ''));
            row.append($('<td></td>').text(log.MESSAGE || ''));
            row.append($('<td></td>').text(log.TECH_DETAILS || ''));
            row.append($('<td></td>').text(log.PAGE_ID || ''));
            row.append($('<td></td>').text(log.ENG_ID || ''));
            row.append($('<td></td>').text(log.USER_PPNO || ''));

            tbody.append(row);
        });
    }

    function formatLogTime(value) {
        if (!value) {
            return '';
        }

        var parsed = new Date(value);
        if (isNaN(parsed.getTime())) {
            return value;
        }

        return parsed.toLocaleString();
    }
</script>
